{%extends "base.html"%}

{%block title%} Home {%endblock%}


{%block content%}

{%if error%}
<div class="alert alert-danger text-center mb-3" role="alert" id="error">{{ error }}</div>
{%endif%}

<div class="alert alert-secondary mt-3" role="alert">
  Logged in as: <strong>{{ username }}</strong>
</div>

<div id="homepage" name="homepage">
    <p>HOME</p>
    <button id="create_todo_button" name="create_todo_button">create todo</button>
    <button id="get_todos_button" name="get_todos_button">get todos</button>
    <button id="logout_button" name="logout_button">log out</button>
</div>

{%if todos%}
<div id="todos_div" name="todos_div" class="todos_div d-flex flex-wrap gap-3"></div>
{%endif%}

<script>

function formatDate(dateStr) {
  if (!dateStr || dateStr.trim() === "") {
    return "Unspecified";
  }
  const date = new Date(dateStr);

  if (isNaN(date.getTime())) {
    return dateStr; 
  }

  return date.toLocaleDateString("en-GB");
}

const todos = {{ todos | tojson }};
console.log(todos)

const todoList = document.getElementById("todos_div");
todos.forEach(todo => {
    var content =
            `<div class="card shadow-sm mb-3 border-0" style="height: 200px; width: 200px;">
            <div class="card-body d-flex flex-column py-2">
                <h6 class="card-title mb-1 fw-semibold text-truncate text-center p-2">${todo.name}</h6>
                <p class="card-text text-muted small mb-2 flex-grow-1 overflow-auto"
                style="max-height: 100px; word-wrap: break-word;">
                ${todo.description}
                </p>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                <small class="text-secondary">Due: ${formatDate(todo.due_date)}</small>
                <span class="badge bg-primary">${todo.status || "todo"}</span>
                </div>
            </div>
            </div>`;
    todoList.innerHTML += content;
});


document.getElementById("create_todo_button").onclick = function() {
    location.href = "http://127.0.0.1:5000/create_todo"
};

document.getElementById("logout_button").onclick = function() {
    location.href = "http://127.0.0.1:5000/logout"
};

function closeOpenPanels(exceptBody = null) {
    document.querySelectorAll("#todos_div .card-body.edit-mode").forEach(body => {
        if (body === exceptBody) return;
        if (body.dataset.original) {
            body.innerHTML = body.dataset.original;
            delete body.dataset.original;
        }
        body.classList.remove("edit-mode");
    })
}; 

function openPanel(body) {
    body.dataset.original = body.innerHTML;
    body.classList.add("edit-mode");

    body.innerHTML = 
    `<div class="d-flex flex-column justify-content-center align-items-center h-100">
      <div class="btn-group btn-group-sm w-75" role="group">
        <button class="btn btn-outline-primary">Edit</button>
        <button class="btn btn-outline-success">Done</button>
        <button class="btn btn-outline-danger">Delete</button>
      </div>
      <button class="btn btn-link mt-2 cancel-edit">Cancel</button>
    </div>`;
};

todoList.addEventListener("click", (event) => {
    const card = event.target.closest(".card");
    if (!card) return;

    // let the cancel button handler close the panel instead
    if (event.target.classList.contains("cancel-edit")) return;

    // stops card from immediately getting reverted to original again
    event.stopPropagation();

    const body = card.querySelector(".card-body");
    if (body.classList.contains("edit-mode")) return;

    closeOpenPanels(body);
    openPanel(body);
});

// eventlistener for the cancel-edit button inside the edit-card panel
document.addEventListener("click", (event) => {
    if (event.target.classList.contains("cancel-edit")) {
        event.stopPropagation()
        
        // resets the body to the original content
        const body = event.target.closest(".card-body");
        body.innerHTML = body.dataset.original;

        body.classList.remove("edit-mode");
        delete body.dataset.original;
    };
});

// when clicking outside a card it closes the currently open card
// this only works combined while stoppropagation() is in todolist.addeventlistener   
document.addEventListener("click", (event) => {
    if (event.target.classList.contains(".card-body")) return;
    document.querySelectorAll("#todos_div .card-body").forEach(body => {
        if (body.dataset.original) {
            body.innerHTML = body.dataset.original;
            delete body.dataset.original;
        }
        body.classList.remove("edit-mode");
    });
});
</script>
{%endblock%}